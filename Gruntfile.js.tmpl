
module.exports = function(grunt) {

    //TODO: change the following variable to your shire_for_mobile directory
    var publicDir = '/Users/dexteryy/code/douban/vagrant/shire-git';

    grunt.initConfig({
        pkg: grunt.file.readJSON('package.json'),
        meta: {
            distDir: 'dist',
            staticDir: 'static',
            examplesDir: 'examples',
            jsPublicDir: publicDir + '/static/js/<%= pkg.name %>',
            cssPublicDir: publicDir + '/static/css/<%= pkg.name %>',
            picsPublicDir: publicDir + '/pics/<%= pkg.name %>'
        },

        clean: {
            dist: ["<%= meta.distDir %>"],
            test: ["<%= meta.examplesDir %>/dist"],
            statics: ["<%= meta.staticDir %>"]
        },

        furnace: {
            tpl: {
                options: {
                    importas: 'tpl',
                    exportas: 'amd'
                },
                files: [{
                    expand: true,     // Enable dynamic expansion.
                    cwd: 'tpl/',
                    src: ['**/*.tpl'], // Actual pattern(s) to match.
                    dest: 'js/<%= pkg.name %>/tpl/',   // Destination path prefix.
                    ext: '.js'
                }]
            }
        },

        ozma: {
            main: {
                saveConfig: true,
                src: 'js/main.js',
                config: {
                    baseUrl: "js/mod/",
                    distUrl: "<%= meta.distDir %>/js/mod/",
                    loader: "../lib/oz.js",
                    disableAutoSuffix: true
                }
            },
            browsers: {
                src: 'examples/js/browsers_test.js',
                config: {
                    baseUrl: "js/mod/",
                    loader: "../lib/oz.js"
                }
            }
        },

        compass: {
            main: {
                options: {
                    config: 'css/config.rb',
                    sassDir: 'css',
                    cssDir: '<%= meta.distDir %>/css',
                    imagesDir: '<%= meta.distDir %>/pics',
                    relativeAssets: true,
                    outputStyle: 'expanded',
                    noLineComments: false,
                    require: [
                        'compass-normalize',
                        'animation',
                        'animate-sass',
                        'ceaser-easing',
                        'compass-recipes'
                    ],
                    environment: 'production'
                }
            }
        },

        imagemin: {
            main: {
                options: {
                    optimizationLevel: 3
                },
                files: {
                    '<%= meta.distDir %>/pics/': 'pics/**/*.{png,jpg}'
                }
            }
        },

        concat: {
            options: {
                stripBanners: true,
                banner: '/*! <%= pkg.name %> - v<%= pkg.version %> */\n'
            },
            js_main: {
                src: ['<%= meta.distDir %>/js/main.js'],
                dest: '<%= meta.staticDir %>/js/main.src.js'
            },
            css_main: {
                src: ['<%= meta.distDir %>/css/main.css'],
                dest: '<%= meta.staticDir %>/css/main.src.css'
            }
        },

        uglify: {
            main: {
                src: ['<%= concat.js_main.dest %>'],
                dest: '<%= meta.staticDir %>/js/main.js'
            }
        },

        cssmin: {
            main: {
                src: ['<%= concat.css_main.dest %>'],
                dest: '<%= meta.staticDir %>/css/main.css'
            }
        },

        copy: {
            dist2examples: {
                files: {
                    "<%= meta.examplesDir %>/": [
                        "<%= meta.distDir %>/js/**", 
                        "<%= meta.distDir %>/css/**",
                        "<%= meta.distDir %>/pics/**"
                    ]
                }
            },
            dist2pub: {
                files: [{
                    expand: true,
                    cwd: '<%= meta.distDir %>/js/',
                    src: ['**'],
                    dest: '<%= meta.jsPublicDir %>/'
                }, {
                    expand: true,
                    cwd: '<%= meta.distDir %>/css/',
                    src: ['**'],
                    dest: '<%= meta.cssPublicDir %>/'
                }]
            },
            static2pub: {
                files: [{
                    expand: true,
                    cwd: '<%= meta.staticDir %>/js/',
                    src: ['**'],
                    dest: '<%= meta.jsPublicDir %>/'
                }, {
                    expand: true,
                    cwd: '<%= meta.staticDir %>/css/',
                    src: ['**'],
                    dest: '<%= meta.cssPublicDir %>/'
                }]
            }
        },

        jshint: {
            options: {
                // Settings
                "passfail": false,             // Stop on first error.
                // Env
                "browser": true,               // Standard browser globals e.g. `window`, `document`.
                "nonstandard": true,
                "node": true,
                "globals": {
                    "ActiveXObject": true,
                    "require": true,
                    "define": true,
                    "module":true
                },
                // Development.
                "devel": false,                // Allow developments statements e.g. `console.log();`.
                "debug": false,                // Allow debugger statements e.g. browser breakpoints.
                // ECMAScript 5.
                "es5": true,                   // Allow ECMAScript 5 syntax.
                "strict": false,               // Require `use strict` pragma in every file.
                "esnext": false,               // tells JSHint that your code uses ES.next specific features such as const and let
                // The Good Parts.
                "eqeqeq": false,               // prohibits the use of == and != in favor of === and !==
                "eqnull": true,                // Tolerate use of `== null`.
                "immed": true,                 // Require immediate invocations to be wrapped in parens e.g. `( function(){}() );`
                "noarg": true,                 // Prohibit use of `arguments.caller` and `arguments.callee`.
                "undef": true,                 // Require all non-global variables be declared before they are used.
                "unused": true,                // warns when you define and never use your variables.
                "trailing": false,             // makes it an error to leave a trailing whitespace in your code
                "boss": true,                  // Tolerate assignments inside if, for & while. Usually conditions & loops are for comparison, not assignments.
                "evil": true,                  // Tolerate use of `eval`.
                "shadow": true,                // suppresses warnings about variable shadowing i.e. declaring a variable that had been already declared somewhere in the outer scope.
                "proto": true,                 // suppresses warnings about the __proto__ property
                "validthis": true,             // suppresses warnings about possible strict violations when the code is running in strict mode and you use this in a non-constructor function
                // Personal styling preferences.
                //"indent": 4,                   // Specify indentation spacing
                "asi": false,                  // suppresses warnings about missing semicolons
                "laxbreak": true,              // Tolerate unsafe line breaks e.g. `return [\n] x` without semicolons.
                "laxcomma": true,              // suppresses warnings about comma-first coding style
                "curly": false,                 // Require {} for every new block or scope.
                "nonew": true,                 // Prohibit use of constructors for side-effects.
                "sub": true,                   // Tolerate all forms of subscript notation besides dot notation e.g. `dict['key']` instead of `dict.key`.
                "loopfunc": true,              // suppresses warnings about functions inside of loops.
                "regexdash": true,             // suppresses warnings about unescaped - in the end of regular expressions
                "white": false,                // Check against strict whitespace and indentation rules.
                "scripturl": true,             // Tolerate script-targeted URLs.
                "multistr": true               // suppresses warnings about multi-line strings
            },
            main: ['./*.js', 'js/**/*.js', '!js/mod/**']
        },

        complexity: {
            generic: {
                src: ['js/cardkit/**/*.js', '!js/cardkit/tpl/**'],
                options: {
                    cyclomatic: 10,
                    halstead: 25,
                    maintainability: 100
                }
            }
        },

        connect: {
            examples: {
                options: {
                    hostname: 'ck.douban.com',
                    port: 9001,
                    base: 'examples/',
                    keepalive: true
                }
            }
        },

        watch: {
            dev: {
                files: [
                    'tpl/**/*.tpl', 
                    'pics/**/*.{png,jpg}', 
                    'js/**/*.js', 
                    'examples/js/**/*.js', 
                    'css/**/*.scss'
                ],
                tasks: [
                    'clean:dist', 
                    'clean:test', 
                    'furnace:tpl', 
                    'imagemin', 
                    'ozma', 
                    'compass', 
                    'copy:dist2examples'
                ]
            },
            pub: {
                files: [
                    'tpl/**/*.tpl', 
                    'pics/**/*.{png,jpg}', 
                    'js/**/*.js', 
                    'examples/js/**/*.js', 
                    'css/**/*.scss'
                ],
                tasks: [
                    'clean:dist', 
                    'clean:test', 
                    'furnace:tpl', 
                    'imagemin', 
                    'ozma', 
                    'compass', 
                    'copy:dist2examples', 
                    'copy:dist2pub'
                ]
            }
        }

    });

    grunt.loadNpmTasks('grunt-contrib-concat');
    grunt.loadNpmTasks('grunt-contrib-clean');
    grunt.loadNpmTasks('grunt-contrib-copy');
    grunt.loadNpmTasks('grunt-contrib-watch');
    grunt.loadNpmTasks('grunt-contrib-jshint');
    grunt.loadNpmTasks('grunt-contrib-imagemin');
    grunt.loadNpmTasks('grunt-contrib-cssmin');
    grunt.loadNpmTasks('grunt-contrib-uglify');
    grunt.loadNpmTasks('grunt-contrib-compass');
    grunt.loadNpmTasks('grunt-contrib-livereload');
    grunt.loadNpmTasks('grunt-contrib-connect');
    grunt.loadNpmTasks('grunt-complexity');

    grunt.loadNpmTasks('grunt-furnace');
    grunt.loadNpmTasks('grunt-ozjs');
    
    grunt.registerTask('dev', [
        'jshint',
        'clean:dist',
        'furnace:tpl',
        'ozma',
        'imagemin',
        'compass'
    ]);

    grunt.registerTask('test', [
        'clean:test',
        'copy:dist2examples'
    ]);

    grunt.registerTask('deploy', [
        'clean:statics',
        'concat',
        'uglify', 
        'cssmin'
    ]);

    grunt.registerTask('default', [
        'dev',
        'test',
        'deploy'
    ]);

};
